## 技术选型

项目是基于 pear admin layui 的前后端半分离项目。不分离部分是因为需要 flask 返回静态页面，并且在静态页面渲染中可以根据自己的需求选择是否使用 jinja2 模板语法。分离部分为后台管理的各种 restful api 接口，动态修改数据。



后端选择 flask 内置的 [MethodView](https://flask.palletsprojects.com/en/1.1.x/views/#method-based-dispatching) 实现 restful api 接口，参数校验选择 [flask-pydantic](https://github.com/bauerji/flask-pydantic) ，权限验证选择使用 [flask-jwt-extended](https://github.com/vimalloc/flask-jwt-extended) 。



前端选择使用 axios 实现前后端数据交互。



**参考** 

RESTful API 设计指南：https://www.ruanyifeng.com/blog/2014/05/restful_api.html

RESTful API 最佳实践：https://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html

替代 flask-restful 的方案：https://github.com/flask-restful/flask-restful/issues/883



### 后端部分

先在 `pear_admin` 目录下新建一个子包 `api` 后续与接口相关的逻辑全部写在这个目录下。因为是第一个接口，所以暂时不进行分包。

先在 `pear_admin/api/__init__.py` 中新建一个类视图

```python
# -*- coding: utf-8 -*-
from typing import List

from flask import Blueprint, Flask
from flask.views import MethodView
from flask_pydantic import validate
from flask_sqlalchemy import Pagination
from pydantic import BaseModel, Field

from pear_admin.models import UserORM
from pear_admin.utils.functools import register_rest_api_func


class UserApi(MethodView):
    class PaginationModel(BaseModel):
        query: str = Field(default="")
        page: int = Field(default=1)
        pre_page: int = Field(default=10)

    @validate()
    def get(self, uid, query: PaginationModel):
        print(UserORM.query.all())

        filters = []
        if query.query:
            filters.append(UserORM.username.like("%" + query.query + "%"))

        paginate: Pagination = UserORM.query.filter(*filters).paginate(
            page=query.page, per_page=query.pre_page
        )
        items: List[UserORM] = paginate.items
        return {
            "result": {
                "total": paginate.total,
                "page": paginate.page,
                "pre_page": paginate.per_page,
                "users": [
                    {
                        "id": item.id,
                        "username": item.username,
                        "nickname": item.nickname,
                        "gender": item.gender,
                        "mobile": item.mobile,
                        "email": item.email,
                        "state": item.state,
                        "create_at": item.create_at,
                    }
                    for item in items
                ],
            },
            "meta": {
                "message": "查询数据成功",
                "status": "success",
            },
        }

```



然后再注册视图

```python
def register_rest_api_func(app, view, endpoint, url, pk="_id", pk_type="int"):
    view_func = view.as_view(endpoint)
    app.add_url_rule(url, defaults={pk: None}, view_func=view_func, methods=["GET"])
    app.add_url_rule(url, view_func=view_func, methods=["POST"])
    app.add_url_rule(
        f"{url}<{pk_type}:{pk}>", view_func=view_func, methods=["GET", "PUT", "DELETE"]
    )


def register_api(app: Flask):
    api = Blueprint("api", __name__, url_prefix="/api/private/v1")
    register_rest_api_func(api, UserApi, "user_api", "/user/", pk="uid")
    app.register_blueprint(api)

```

`register_rest_api_func` 函数建议移动到 `pear_admin/utils/functools.py` 目录下，因为这个函数在后续很多接口注册中都需要使用到。



最后再在 `pear_admin/__init__.py` 中注册一下接口视图就可以进行访问了。

```python
from pear_admin.api import register_api


def create_app() -> Flask:
	...
	
    register_api(app)
    
	...
    return app

```

### 新增用户数据

#### 前端添加逻辑

文件名：templates/system/user/user.html

```javascript
    // 捕捉表格事件
	table.on('toolbar(user-table)', function(obj) {
      if (obj.event === 'add') {
        window.add();
      } else if (obj.event === 'refresh') {
        window.refresh();
      } else if (obj.event === 'batchRemove') {
        window.batchRemove(obj);
      }
    });
	
	// 请求获取添加视图
	window.add = function() {
      layer.open({
        type: 2,
        title: '新增',
        shade: 0.1,
        area: ['60%', '80%'],
        content: MODULE_PATH + 'add',
      });
    };
```

#### 前端添加页面

文件名：templates/system/user/user_add.html

```html
<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=UTF-8>
    <title>新增页面</title>
    <link rel=stylesheet href=/static/component/pear/css/pear.css>
</head>
<body>
<form class=layui-form lay-filter=user-form>
    <div class=mainBox>
        <div class=main-container>
            <div class=layui-form-item>
                <label class=layui-form-label>账号</label>
                <div class=layui-input-block>
                    <input type=text name=username lay-verify=required autocomplete=off placeholder=请输入标题 required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>姓名</label>
                <div class=layui-input-block>
                    <input type=text name=nickname lay-verify=required autocomplete=off placeholder=请输入标题 required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>密码</label>
                <div class=layui-input-block>
                    <input type=text name=password lay-verify=required autocomplete=off placeholder=请输入标题 required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>电话</label>
                <div class=layui-input-block>
                    <input type=text name=mobile lay-verify=required autocomplete=off placeholder=请输入标题
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>邮箱</label>
                <div class=layui-input-block>
                    <input type=text name=email autocomplete=off placeholder=请输入标题 class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>性别</label>
                <div class=layui-input-block>
                    <input type=radio name=gender value=男 title=男>
                    <input type=radio name=gender value=女 title=女 checked>
                    <input type=radio name=gender value=保密 title=保密>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>学历</label>
                <div class=layui-input-block>
                    <select name="education" lay-verify="required">
                        <option value="博士">博士</option>
                        <option value="硕士">硕士</option>
                        <option value="本科" selected>本科</option>
                        <option value="专科">专科</option>
                        <option value="高中">高中</option>
                        <option value="初中">初中</option>
                        <option value="小学">小学</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class=bottom>
        <div class=button-container>
            <button type=submit class="pear-btn pear-btn-primary pear-btn-sm" lay-submit lay-filter=user-save>
                <i class="layui-icon layui-icon-ok"></i> 提交
            </button>
            <button type=reset class="pear-btn pear-btn-sm">
                <i class="layui-icon layui-icon-refresh"></i> 重置
            </button>
        </div>
    </div>
</form>
<script src=/static/component/layui/layui.js></script>
<script src=/static/component/pear/pear.js></script>
<script>
  layui.use(['form', 'jquery'], function() {
    let form = layui.form;
    let $ = layui.jquery;

    form.on('submit(user-save)', function(data) {
      $.ajax({
        url: '/api/private/v1/user/',
        data: JSON.stringify(data.field),
        dataType: 'json',
        contentType: 'application/json',
        type: 'post',
        success: function(result) {
          if (result.meta.status === 'success') {
            layer.msg(result.meta.message, {
              icon: 1,
              time: 1000,
            }, function() {
              parent.layer.close(parent.layer.getFrameIndex(window.name)); //关闭当前页
              parent.layui.table.reload('user-table');
            });
          } else {
            layer.msg(result.meta.message, {
              icon: 2,
              time: 1000,
            });
          }
        },
      });
      return false;
    });
  });
</script>
</body>
</html>
```

#### 后端添加视图

```python
# filename: pear_admin/views/__init__.py


@view_bp.get("/user/add")
def user_add_view():
    return render_template("system/user/user_add.html")

```

#### 后端添加逻辑

```python
# filename: pear_admin/api/__init__.py

class UserApi(MethodView):
	class UserModel(BaseModel):
        username: str = Field(default="")
        nickname: str = Field(default="")
        password: str = Field(default="")
        mobile: str = Field(default="")
        email: str = Field(default="")
        gender: str = Field(default="")
        education: str = Field(default="")
        state: bool = Field(default=False)
    
    @validate()
    def post(self, body: UserModel):
        user = UserORM()
        user.username = body.username
        user.nickname = body.nickname
        user.password = body.password
        user.mobile = body.mobile
        user.email = body.email
        user.gender = body.gender
        user.education = body.education
        db.session.add(user)
        db.session.commit()
        return {
            "meta": {
                "message": "添加数据成功",
                "status": "success",
            },
        }

```

### 编辑用户数据

#### 前端编辑逻辑

文件名：templates/system/user/user.html

```javascript
    table.on('tool(user-table)', function(obj) {
      if (obj.event === 'remove') {
        window.remove(obj);
      } else if (obj.event === 'edit') {
        window.edit(obj);
      }
    });
    
	window.edit = function(obj) {
      console.log(obj);
      layer.open({
        type: 2,
        title: '修改',
        shade: 0.1,
        area: ['500px', '400px'],
        content: MODULE_PATH + 'edit' + `?uid=${obj.data.id}`, // 使用 uid 确定加载的数据
      });
    };
```

#### 前端编辑页面

文件名：templates/system/user/user_edit.html

```html
<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=UTF-8>
    <title>编辑页面</title>
    <link rel=stylesheet href=/static/component/pear/css/pear.css>
</head>
<body>
<form class=layui-form lay-filter=user-form>
    <div class=mainBox>
        <div class=main-container>
            <div class=layui-form-item style="display: none">
                <label class=layui-form-label>用户id</label>
                <div class=layui-input-block>
                    <input type=text name=uid lay-verify=required autocomplete=off placeholder=请输入id required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>账号</label>
                <div class=layui-input-block>
                    <input type=text name=username lay-verify=required autocomplete=off placeholder=请输入标题 required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>姓名</label>
                <div class=layui-input-block>
                    <input type=text name=nickname lay-verify=required autocomplete=off placeholder=请输入标题 required
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>电话</label>
                <div class=layui-input-block>
                    <input type=text name=mobile lay-verify=required autocomplete=off placeholder=请输入标题
                           class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>邮箱</label>
                <div class=layui-input-block>
                    <input type=text name=email autocomplete=off placeholder=请输入标题 class=layui-input>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>性别</label>
                <div class=layui-input-block>
                    <input type=radio name=gender value=男 title=男>
                    <input type=radio name=gender value=女 title=女 checked>
                    <input type=radio name=gender value=保密 title=保密>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>学历</label>
                <div class=layui-input-block>
                    <select name="education" lay-verify="required">
                        <option value="博士">博士</option>
                        <option value="硕士">硕士</option>
                        <option value="本科" selected>本科</option>
                        <option value="专科">专科</option>
                        <option value="高中">高中</option>
                        <option value="初中">初中</option>
                        <option value="小学">小学</option>
                    </select>
                </div>
            </div>
            <div class=layui-form-item>
                <label class=layui-form-label>状态</label>
                <div class=layui-input-block>
                    <input type=checkbox lay-skin="switch" name=state lay-text="开启|关闭" autocomplete=off
                           placeholder=请输入标题 class=layui-input>
                </div>
            </div>
        </div>
    </div>
    <div class=bottom>
        <div class=button-container>
            <button type=submit class="pear-btn pear-btn-primary pear-btn-sm" lay-submit lay-filter=user-save>
                <i class="layui-icon layui-icon-ok"></i> 提交
            </button>
            <button type=reset class="pear-btn pear-btn-sm">
                <i class="layui-icon layui-icon-refresh"></i> 重置
            </button>
        </div>
    </div>
</form>
<script src=/static/component/layui/layui.js></script>
<script src=/static/component/pear/pear.js></script>
<script>
  layui.use(['form', 'jquery'], function() {
    let form = layui.form;
    let $ = layui.jquery;

    form.val('user-form', {
      'uid': '{{user.id}}'
      , 'username': '{{user.username}}'
      , 'nickname': '{{user.nickname}}'
      , 'mobile': '{{user.mobile}}'
      , 'email': '{{user.email}}'
      , 'gender': '{{user.gender}}'
      , 'state': {{"true" if user.state else "false"}}
      , 'education': '{{user.education}}',
    });

    form.on('submit(user-save)', function(data) {
      let send_data = Object.assign({}, data.field);
      send_data.state = send_data.state === 'on';
      $.ajax({
        url: `/api/private/v1/user/${data.field.uid}`,
        data: JSON.stringify(send_data),
        dataType: 'json',
        contentType: 'application/json',
        type: 'put',
        success: function(result) {
          if (result.meta.status === 'success') {
            layer.msg(result.meta.message, {
              icon: 1,
              time: 1000,
            }, function() {
              parent.layer.close(parent.layer.getFrameIndex(window.name)); //关闭当前页
              parent.layui.table.reload('user-table');
            });
          } else {
            layer.msg(result.meta.message, {
              icon: 2,
              time: 1000,
            });
          }
        },
      });
      return false;
    });
  });
</script>
</body>
</html>
```

#### 后端添加视图

```python
# filename: pear_admin/views/__init__.py

@view_bp.get("/user/edit")
def user_edit_view():
    uid = request.args.get("uid", type=int)
    if not uid:
        return abort(404)
    user = UserORM.query.get(uid)
    return render_template("system/user/user_edit.html", user=user)

```

#### 后端添加逻辑

```python
# filename: pear_admin/api/__init__.py

class UserApi(MethodView):
    class UserModel(BaseModel):
        username: str = Field(default="")
        nickname: str = Field(default="")
        password: str = Field(default="")
        mobile: str = Field(default="")
        email: str = Field(default="")
        gender: str = Field(default="")
        education: str = Field(default="")
        state: bool = Field(default=False)


    @validate()
    def put(self, uid, body: UserModel):
        print(body)
        user = UserORM.query.get(uid)
        user.username = body.username
        user.nickname = body.nickname
        if body.username:
            user.password = body.password
        user.mobile = body.mobile
        user.email = body.email
        user.gender = body.gender
        user.education = body.education
        user.state = body.state
        db.session.add(user)
        db.session.commit()
        return {
            "meta": {
                "message": "修改数据成功",
                "status": "success",
            },
        }

```

### 删除数据

前端删除逻辑

```javascript
    table.on('tool(user-table)', function(obj) {
      if (obj.event === 'remove') {
        window.remove(obj);
      } else if (obj.event === 'edit') {
        window.edit(obj);
      }
    });
    
	window.remove = function(obj) {
      layer.confirm('确定要删除该用户', {
        icon: 3,
        title: '提示',
      }, function(index) {
        layer.close(index);
        let loading = layer.load();
        $.ajax({
          url: '/api/private/v1/user/' + obj.data['id'],
          dataType: 'json',
          type: 'delete',
          success: function(result) {
            layer.close(loading);
            if (result.meta.status === 'success') {
              layer.msg(result.meta.message, {
                icon: 1,
                time: 1000,
              }, function() {
                obj.del();
              });
            } else {
              layer.msg(result.meta.message, {
                icon: 2,
                time: 1000,
              });
            }
          },
        });
      });
    };

```

后端删除逻辑

```python
# filename: pear_admin/api/__init__.py

class UserApi(MethodView):
	def delete(self, uid):
        if uid in [1, 2, 3]:
            return {
                "meta": {
                    "message": "测试数据禁止删除",
                    "status": "fail",
                },
            }
        user = UserORM.query.get(uid)
        db.session.delete(user)
        db.session.commit()
        return {
            "meta": {
                "message": "删除数据成功",
                "status": "success",
            },
        }

```

