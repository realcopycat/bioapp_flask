## 项目搭建



### poetry

> 官网地址：https://python-poetry.org/ 

安装 poetry 环境

```
pip install poetry
```

初始化项目

```
poetry init
```

然后不断会出，就会生成以下配置文件

```
[tool.poetry]
name = "pear-admin-flask"
version = "0.1.0"
description = ""
authors = ["zhengxinonly <pyxxponly@gmail.com>"]

[tool.poetry.dependencies]
python = "^3.10"

[tool.poetry.dev-dependencies]

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

```

在最后添加 poetry 的软件安装源

```
[[tool.poetry.source]]
name = "aliyun"
url = "http://mirrors.aliyun.com/pypi/simple/"
default = true
```

#### 添加依赖

```
poetry add flask
poetry add flask-sqlalchemy
poetry add flask-migrate
poetry add flask-pydantic
poetry add python-dotenv
```

注意：关于 poetry 的使用方式可以看官方文档。

### 代码风格

代码使用 [isort](https://pycqa.github.io/isort/) 与 [black](https://black.readthedocs.io/en/stable/) 进行风格统一，并且使用 [pre-comment](https://pre-commit.com/) 在 git 提交之前对代码进行校验。

安装依赖

```
poetry add isort
poetry add black
poetry add pre-commit
```

使用方式

参考：

[isort 井井有条 —— Python 导入格式化工具](https://muzing.top/posts/38b1b99e/)  

[五彩斑斓的 Black —— Python 代码格式化工具](https://muzing.top/posts/a29e4743/)



#### pre-commit 使用

安装

```
$ pip install pre-commit
```

查看版本

```
$ pre-commit --version
pre-commit 2.20.0
```

编写配置文件

在项目的根目录下新建一个 `.pre-commit-config.yaml` 文件，然后往里面写入 isort 与 black 的校验。

```
repos:
-   repo: https://github.com/python/black
    rev: 22.1.0
    hooks:
    - id: black
      language_version: python3.8
-   repo: https://github.com/pycqa/isort
    rev: 5.10.1
    hooks:
      - id: isort
        args: ["--profile", "black", "--filter-files"]
```

初始化 pre-commit

```
$ pre-commit install
pre-commit installed at .git/hooks/pre-commit
```

之后的 git 提交，都在校验代码风格，如果出了问题就会提示修改，这样就可以保证代码风格统一了。

### 前端静态文件获取

项目的前端部分使用 pear admin layui，此项目有两个分支，main 分支是提供的原始文件，在 package 分支中提供了 gulp 可以获取打包之后的文件，对于 pear admin flask 来说，使用打包之后的文件性能会更好一些。

克隆项目文件到本地

```
$ git clone https://gitee.com/pear-admin/Pear-Admin-Layui.git
```

切换到 package 分支并安装依赖

```
$ cd Pear-Admin-Layui
$ git checkout package
$ npm install
```

运行 gulp 打包文件，默认执行所有的打包

```
$ gulp
```

然后目录下就会生成一个 dist 打包好的文件夹，这个就是目标文件。

### pear admin layui 介绍

获取静态资源之后，目录结构里面有很多东西，但是实际重要的内容并不是很多

```
│  index.html
│  login.html
│
├─admin
│  ├─css						# 存放系统重要的一些样式
│  │  │  admin.css
│  │  │  loader.css
│  │  └─other					# 其他子页面的样式
│  ├─data						# 里面都是系统需要用到的配置文件
│  │      menu.json				# 菜单栏样式
│  │      power.json			# 权限数据
│  │      role.json				# 角色权限数据
│  │      user.json				# 用户数据
│  └─images						# 一些静态资源图片
│
├─component
│  ├─code
│  │  │  index.html
│  ├─layui						# layui 的源码与文件
│  │  │  layui.js
│  │  ├─css
│  │  └─font
│  │
│  └─pear						# pear admin 的源码与文件
│      │  pear.js
│      │
│      ├─css
│      │  │  pear.css			# pear admin 的 css 样式
│      │  └─module				# pear 系统的 css 样式
│      ├─font					# pear 系统的 字体文件
│      └─module					# pear 系统的 js 模块
│          │  admin.js			# pear admin 核心模块 
│          │  menu.js			# 菜单模块
│          │  popup.js			# 弹出模块
│          │  select.js			# select 选择模块
│          │  treetable.js		# 树形表格模块
│          └─tinymce			# 富文本模块
│
├─config						# 项目启动需加载的配置文件
│      pear.config.json
│      pear.config.yml
└─view							# 静态页面
    ├─console
    ├─demo
    │      index.html
    ├─document					# 常用组件 html 目录
    ├─echarts					# 数据表格页面（echarts 绘图组件）
    │  └─script					# echarts 绘图代码
    ├─error						# 错误页面
    ├─result					# 结果页面
    └─system					# 系统管理 html 
```



pear admin layui 的启动文件是`index.html`, 调用 admin 模块请求配置参数，启动核心代码是  `component/pear/module/admin.js` , 在 admin.js 里面会请求左侧菜单栏的数据，并且配置菜单导航栏。 默认是使用 yml 文件，而 pear admin flask 中使用的是 json 数据，所以这里面需要修改一下。

```
				admin.setConfigType("json");
				admin.setConfigPath("config/pear.config.json");
```

`config/pear.config.json` 是整个项目的配置文件，这个应该由后端接口返回，也是后面重点需要修改的东西。

这个文件中有个 `admin/data/menu.json` 路径，这个是后端返回的路由表数据，这个也是新增页面的一个重点。修改里面的数据可以控制右侧显示的菜单栏。

### pear admin flask 搭建

pear admin layui 里面有非常多的页面，但是pear admin flask 并不需要那么多的东西，所以需要做一些简化。

首先是简化 `admin/data/menu.json` 文件，将不需要的页面路由都给删除，然后留下一些基本的页面。

```
[
  {
    "id": 1,
    "title": "工作空间",
    "icon": "layui-icon layui-icon-console",
    "type": 0,
    "href": "",
    "children": [
      {
        "id": 10,
        "title": "控制后台",
        "icon": "layui-icon layui-icon-console",
        "type": 1,
        "openType": "_iframe",
        "href": "view/console/console1.html"
      }
    ]
  },
  {
    "id": "system",
    "title": "系统管理",
    "icon": "layui-icon layui-icon-set-fill",
    "type": 0,
    "href": "",
    "children": [
      {
        "id": 601,
        "title": "用户管理",
        "icon": "layui-icon layui-icon-face-smile",
        "type": 1,
        "openType": "_iframe",
        "href": "view/system/user.html"
      },
      {
        "id": 602,
        "title": "角色管理",
        "icon": "layui-icon layui-icon-face-cry",
        "type": 1,
        "openType": "_iframe",
        "href": "view/system/role.html"
      },
      {
        "id": 603,
        "title": "权限管理",
        "icon": "layui-icon layui-icon-face-cry",
        "type": 1,
        "openType": "_iframe",
        "href": "view/system/power.html"
      },
      {
        "id": 604,
        "title": "部门管理",
        "icon": "layui-icon layui-icon-face-cry",
        "type": 1,
        "openType": "_iframe",
        "href": "view/system/deptment.html"
      },
      {
        "id": 605,
        "title": "行为日志",
        "icon": "layui-icon layui-icon-face-cry",
        "type": 1,
        "openType": "_iframe",
        "href": "view/system/log.html"
      }
    ]
  },
  {
    "id": "echarts",
    "title": "数据图表",
    "icon": "layui-icon layui-icon-chart",
    "type": 0,
    "href": "",
    "children": [
      {
        "id": 12121,
        "title": "折线图",
        "icon": "layui-icon layui-icon-face-smile",
        "type": 1,
        "openType": "_iframe",
        "href": "view/echarts/line.html"
      },
      {
        "id": 121212,
        "title": "柱状图",
        "icon": "layui-icon layui-icon-face-smile",
        "type": 1,
        "openType": "_iframe",
        "href": "view/echarts/column.html"
      }
    ]
  }
]
```

上面就是整个路由表的 JSON 文件数据，具体参数作用：

+ title 标题
+ icon 图标
+ type 菜单类型（0为一级菜单）
+ openType  打开方式
+ href 访问页面地址

#### 移动文件

然后将静态文件与静态资源复制到项目的 'templates' 与 'static' 目录下，并且在项目中添加视图。



##### templates

```
│  index.html
│  login.html
│
├─console
│      console1.html
│      console2.html
│
└─system
    │  deptment.html
    │  log.html
    │  operate.html
    │  person.html
    │  power.html
    │  profile.html
    │  role.html
    │  space.html
    │  theme.html
    │  user.html
    │
    └─operate
            add.html
            edit.html
            profile.html
```



##### static

```
├─admin
│  ├─css
│  │  │  admin.css
│  │  │  loader.css
│  │  └─other
│  ├─data
│  │      card.json
│  │      menu.json
│  │      message.json
│  └─images
├─component
│  ├─layui
│  │  │  layui.js
│  │  │
│  │  ├─css
│  │  │  │  layui.css
│  │  │  │
│  │  │  └─modules
│  │  └─font
│  └─pear
│      │  pear.js
│      ├─css
│      │  │  pear.css
│      │  │
│      │  └─module
│      ├─font
│      └─module
│          │  admin.js
│          └─tinymce
└─config
        pear.config.json
```

##### 视图函数

```
# -*- coding: utf-8 -*-
# filename: pear_admin/view/__init__.py
from flask import Blueprint, render_template

view_bp = Blueprint("views", __name__)


@view_bp.get("/")
def index():
    return render_template("index.html")


@view_bp.get("/dashboard")
def console_view():
    return render_template("console/console1.html")

```

然后修改一下 'menu.json' 文件的视图路径，就可以获取到页面的数据了。并且视图函数需要注册到 app 对象上。

#### 模板语法

改完之后，有部分页面是无法直接访问的，原价是 jinja2 的模板语法与 layui 的模板语法起了冲突，在这个项目中选择直接使用 es6 的模板语法，所以需要修改一下页面的逻辑，将 layui 的模板语法改为 JavaScript 的模板字符串即可。



修改之前需要看一下 laytpl 的文档，知道原理才能更好的修改。

layui模板语法文档：https://layuion.com/docs/modules/laytpl.html 

layui table 自定义列模板：https://layuion.com/docs/modules/table.html#templet
