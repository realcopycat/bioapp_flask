## 数据模型创建

> flask-sqlalchemy：https://github.com/pallets-eco/flask-sqlalchemy
>
> Flask-Migrate：https://github.com/miguelgrinberg/Flask-Migrate
>
> sqlalchemy： https://github.com/zzzeek/sqlalchemy

数据模型创建选择使用 ORM 工具，不用 sql 脚本。

### 初始化插件

新建 `pear_admin/extensions.py` 文件，在里面实例化关系模型对象。并创建一个方法将实例对象注册到 app 对象，然后再讲方法暴露出去。

```python
# -*- coding: utf-8 -*-
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()


def register_extensions(app: Flask) -> None:
    db.init_app(app)
    migrate.init_app(app, db)

```

然后创建配置文件 `config.py`，添加数据库的信息

```python
# mysql 配置
MYSQL_USERNAME = "root"
MYSQL_PASSWORD = "root"

MYSQL_HOST = "127.0.0.1"
MYSQL_PORT = 3306
MYSQL_DATABASE = "pear_admin_flask"
# mysql 数据库的配置信息
SQLALCHEMY_DATABASE_URI = f"mysql+pymysql://{MYSQL_USERNAME}:{MYSQL_PASSWORD}@{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DATABASE}?charset=utf8mb4"
SQLALCHEMY_TRACK_MODIFICATIONS = False

```

然后在 app 中注册配置文件与数据库对象就可以使用了

```python
# -*- coding: utf-8 -*-
from flask import Flask

from pear_admin.views import view_bp
from pear_admin.extensions import register_extensions
import config


def create_app() -> Flask:
    app = Flask("pear-admin-flask")
    # 使用配置文件
    app.config.from_object(config)
    # 注册插件
    register_extensions(app)
    app.register_blueprint(view_bp)
    return app

```

### 创建数据模型

新建 `pear_admin/models.py` 然后在里面定义数据模型。

```python
# -*- coding: utf-8 -*-
from datetime import datetime

from werkzeug.security import generate_password_hash, check_password_hash

from pear_admin.extensions import db

user_role = db.Table(
    "ums_user_role",  # 中间表名称
    db.Column("id", db.Integer, primary_key=True, autoincrement=True, comment="标识"),
    db.Column("user_id", db.Integer, db.ForeignKey("ums_user.id"), comment="用户编号"),
    db.Column("role_id", db.Integer, db.ForeignKey("ums_role.id"), comment="角色编号"),
)

role_power = db.Table(
    "ums_role_permission",  # 中间表名称
    db.Column("id", db.Integer, primary_key=True, autoincrement=True, comment="标识"),
    db.Column(
        "permission_id", db.Integer, db.ForeignKey("ums_permission.id"), comment="用户编号"
    ),
    db.Column("role_id", db.Integer, db.ForeignKey("ums_role.id"), comment="角色编号"),
)


class UserORM(db.Model):
    __tablename__ = "ums_user"

    id = db.Column(db.Integer, primary_key=True, comment="自增id")
    username = db.Column(db.String(128), nullable=False, comment="登录名")
    password_hash = db.Column(db.String(102), nullable=False, comment="登录密码")
    mobile = db.Column(db.String(32), nullable=False, comment="手机")
    email = db.Column(db.String(64), nullable=False, comment="邮箱")
    gender = db.Column(
        db.Enum("保密", "女", "男"),
        nullable=False,
        default="女",
        comment="性别",
    )
    education = db.Column(
        db.Enum("博士", "硕士", "本科", "专科", "高中", "初中", "小学"),
        nullable=False,
        default="专科",
        comment="学历",
    )
    state = db.Column(db.Boolean, default=False, comment="用户状态 False 停止使用，True 正常使用")
    introduce = db.Column(db.Text, comment="简介")
    avatar = db.Column(db.Text, comment="头像地址")
    create_at = db.Column(
        db.Integer,
        nullable=False,
        comment="创建时间",
        default=datetime.now().timestamp,
    )

    role = db.relationship(
        "RoleORM",
        secondary="ums_user_role",
        backref=db.backref("user"),
        lazy="dynamic",
    )

    @property
    def password(self):
        return self.password_hash

    @password.setter
    def password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password=password)


class RoleORM(db.Model):
    __tablename__ = "ums_role"

    id = db.Column(db.SmallInteger, primary_key=True)
    name = db.Column(db.String(20), nullable=False, comment="角色名称")
    desc = db.Column(db.Text)

    permission_ids = db.Column(
        db.String(512),
        nullable=False,
        comment="权限ids,1,2,5。冗余字段，用户缓存用户权限",
    )

    permission = db.relationship(
        "PermissionORM", secondary="ums_role_permission", backref=db.backref("role")
    )


class PermissionORM(db.Model):
    __tablename__ = "ums_permission"

    id = db.Column(db.SmallInteger, primary_key=True)
    name = db.Column(db.String(20), nullable=False, comment="权限名称")
    level = db.Column(
        db.Enum("1", "2", "3"),
        nullable=False,
        default="1",
        comment="权限等级",
    )
    code = db.Column(db.String(30), comment="权限标识")
    icon = db.Column(db.String(128), comment="图标")
    path = db.Column(db.String(30), comment="访问路径")
    enable = db.Column(db.Boolean, comment="是否开启")
    sort = db.Column(db.Integer, comment="排序")

    pid = db.Column(db.Integer, db.ForeignKey("ums_permission.id"), comment="父类编号")
    parent = db.relationship("PermissionORM", remote_side=[id])  # 自关联

```

在新建数据模型的时候，创建了角色与权限表，用于构建基于角色访问权限管理系统（RBAC），如果对此不懂的可以查看这个视频[【bilibili 】Python Flask 权限管理系统实现]( https://www.bilibili.com/video/BV1tg411X7o5) ，对于里面的细节逻辑在此就不详细赘述了。

### 初始化数据

首先初始化权限数据

```python
    permission_list = [
        {
            "id": 1,
            "name": "工作空间",
            "level": 0,
            "icon": "layui-icon layui-icon-console",
            "path": "",
            "pid": 0,
        },
        {
            "id": 2,
            "name": "控制后台",
            "level": 1,
            "icon": "layui-icon layui-icon-console",
            "path": "/dashboard",
            "pid": 1,
            "open_type": "_iframe",
        },
        {
            "id": 3,
            "name": "系统管理",
            "level": 0,
            "icon": "layui-icon layui-icon-set-fill",
            "path": "",
            "pid": 0,
        },
        {
            "id": 4,
            "name": "用户管理",
            "level": 1,
            "icon": "layui-icon layui-icon-face-smile",
            "path": "/user",
            "pid": 3,
            "open_type": "_iframe",
        },
        {
            "id": 5,
            "name": "角色管理",
            "level": 1,
            "icon": "layui-icon layui-icon-face-cry",
            "path": "/role",
            "pid": 3,
            "open_type": "_iframe",
        },
        {
            "id": 6,
            "name": "权限管理",
            "level": 1,
            "icon": "layui-icon layui-icon-face-cry",
            "path": "/permission",
            "pid": 3,
            "open_type": "_iframe",
        },
        {
            "id": 7,
            "name": "部门管理",
            "level": 1,
            "icon": "layui-icon layui-icon-face-cry",
            "path": "/department",
            "pid": 3,
            "open_type": "_iframe",
        },
        {
            "id": 8,
            "name": "行为日志",
            "level": 1,
            "icon": "layui-icon layui-icon-face-cry",
            "path": "/sys_log",
            "pid": 3,
            "open_type": "_iframe",
        },
        {
            "id": 9,
            "name": "数据图表",
            "level": 0,
            "icon": "layui-icon layui-icon-chart",
            "path": "",
            "pid": 0,
        },
        {
            "id": 10,
            "name": "折线图",
            "level": 1,
            "icon": "layui-icon layui-icon-face-cry",
            "path": "/echarts/line",
            "pid": 9,
            "open_type": "_iframe",
        },
        {
            "id": 11,
            "name": "柱状图",
            "level": 1,
            "icon": "layui-icon layui-icon-face-smile",
            "path": "/echarts/column",
            "pid": 9,
            "open_type": "_iframe",
        },
    ]
    for permission in permission_list:
        permission_obj = PermissionORM()
        for key, value in permission.items():
            setattr(permission_obj, key, value)
        db.session.add(permission_obj)
    db.session.commit()
```

初始化角色数据

```
role_list = [
        {
            "id": 1,
            "name": "超级管理员",
            "desc": "超级管理员",
        },
        {
            "id": 2,
            "name": "普通管理员",
            "desc": "普通管理员",
        },
        {
            "id": 3,
            "name": "普通用户",
            "desc": "普通用户",
        },
    ]
    for role in role_list:
        role_obj = RoleORM()
        for key, value in role.items():
            setattr(role_obj, key, value)
        db.session.add(role_obj)
    db.session.commit()
    role_permission_items = {
        1: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        2: [1, 2, 3, 4, 8, 9, 10, 11],
        3: [1, 2, 9, 10, 11],
    }
    for role_id, role_per_ids in role_permission_items.items():
        role_obj: RoleORM = RoleORM.query.get(role_id)
        role_obj.permission_ids = ",".join(map(str, role_per_ids))
        per_list = PermissionORM.query.filter(PermissionORM.id.in_(role_per_ids)).all()
        role_obj.permission = per_list
    db.session.commit()
```





然后在初始化文件中导入数据模型，再执行数据迁移，生成数据表

```
$ flask db init
$ flask db migrate
$ flask db upgrade
```

然后在数据库中就可以看到新建的数据表。